import logging
import json
import os
import random
import string
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

from flask import Flask
from threading import Thread

# ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù…Ø¬Ø§Ø²Ù‡ ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†Ù‡
OWNER_ID = 6811131989  # â† Ø§ÛŒÙ†Ùˆ Ø¨Ø§ Telegram ID Ø®ÙˆØ¯Øª Ø¹ÙˆØ¶ Ú©Ù†
BOT_USERNAME = "anime_land2025bot"  # â† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø¨Ø§ØªØª Ø¨Ø¯ÙˆÙ† @

STORAGE_FILE = "files.json"

# Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ÙØ§ÛŒÙ„ json Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ØŒ Ø¨Ø³Ø§Ø²
if not os.path.exists(STORAGE_FILE):
    with open(STORAGE_FILE, "w") as f:
        json.dump({}, f)

def generate_code():
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))

def load_files():
    with open(STORAGE_FILE, "r") as f:
        return json.load(f)

def save_files(data):
    with open(STORAGE_FILE, "w") as f:
        json.dump(data, f)

# ğŸ“¥ ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù…Ø¬Ø§Ø²Ù‡ ÙØ§ÛŒÙ„ Ø¨Ø¯Ù‡
async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != OWNER_ID:
        await update.message.reply_text("Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø¯Ø§Ø±ÛŒØ¯ âŒ")
        return

    document = update.message.document
    file_id = document.file_id
    code = generate_code()

    data = load_files()
    data[code] = file_id
    save_files(data)

    link = f"https://t.me/{BOT_USERNAME}?start={code}"
    await update.message.reply_text(f"âœ… ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯\nğŸ“ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú©: {link}")

# ğŸ§· ÙˆÙ‚ØªÛŒ Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© /start Ú©Ø¯ Ú©Ù„ÛŒÚ© Ø´Ø¯
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    if not args:
        await update.message.reply_text("Ø³Ù„Ø§Ù…! ÙØ§ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡.")
        return

    code = args[0]
    data = load_files()

    if code not in data:
        await update.message.reply_text("âŒ ÙØ§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡.")
        return

    file_id = data[code]
    await update.message.reply_document(document=file_id)

# âœ… Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
def main():
    app = Application.builder().token("7511118482:AAHTt6Q9YE6aYRZuyoJvObEc1lYbdVKc55c").build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Document.ALL, handle_document))

    app.run_polling()

# ğŸŒ Ø³Ø±ÙˆØ± Flask Ø¨Ø±Ø§ÛŒ Ø²Ù†Ø¯Ù‡ Ù…ÙˆÙ†Ø¯Ù† Replit
web_app = Flask('')

@web_app.route('/')
def home():
    return "I'm alive"

def run_web():
    web_app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run_web)
    t.start()

# ğŸ§  Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
if __name__ == "__main__":
    keep_alive()
    main()
